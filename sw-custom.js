const e="lets-bike-api",t=self;async function n(e,t){const n=await fetch(e);return await t.put(e,n.clone()),await t.put(`${e.url}-time`,new Response(Date.now().toString())),n}function a(e){t.clients.matchAll().then((t=>{t.forEach((t=>t.postMessage(e)))}))}t.addEventListener("notificationclick",(e=>{const n=e.notification.data;e.waitUntil((async()=>t.clients.matchAll({type:"window",includeUncontrolled:!0}).then((e=>{const a=e.find((e=>"focus"in e&&e.focused));if(a){const e={type:"navigate",payload:{sku:n.sku,to:n.to}};a.postMessage(e)}else t.clients.openWindow("/lets/")})))().then((()=>e.notification.close())))})),t.addEventListener("message",(async n=>{const o=n.data;"cache-reset-request"===o.type&&caches.delete(e).then((t=>{if(t){a({type:"cache-reset-done"}),console.log(`[SW] ${e} cleared`)}})),"push-me"===o.type&&await t.registration.showNotification(o.payload.title,o.payload.options)})),t.addEventListener("fetch",(o=>{const{request:{url:s,method:c}}=o;if("GET"===c&&s.includes("docs.google.com")){const s=t.caches.open(e).then((async e=>{const t=await e.match(o.request);if(t){const s=await e.match(`${o.request.url}-time`);if(s){return!function(e,t){const n=t.getHours(),a=e.getHours();return t.getDate()!==e.getDate()||n!==a}(new Date(Number(await s.text())),new Date)?console.log("Cache is still valid, returning cached data."):(console.log("Cache is stale, fetching new data..."),n(o.request,e).then((e=>{e.text().then((e=>{const t=(e=>{const t=e.replace("/*O_o*/","").replace(/\n/g,"").replace("google.visualization.Query.setResponse(","").replace(/\);$/,""),n=JSON.parse(t).table,a=n.cols.map((e=>e.label));return n.rows.map((e=>{const t={};return e.c.forEach(((n,o)=>{const s=a[o];if("pics"===s&&n){const e=n.v.toString();t[s]=e.includes("[")?Array.from(new Set(JSON.parse(e.replace(/'/g,'"')))):[e]}else if("name"!==s||n)t[s]=n?.v??null;else{const n=a.indexOf("sku"),o=e.c[n];t[s]=o?o.v:"-"}})),t}))})(e);console.log("Cache updated, app notified."),a({type:"cache-updated",payload:{count:t.length}})}))}))),t}}return console.log("No cache found, fetching new data..."),n(o.request,e)}));o.respondWith(s)}}));
